# Домашнее задание #3

1. Базы данных
   - В сервисе Checkout одна таблица `cart_items`, она хранит корзины пользователей.
   - В сервисе LOMS их 4:
     - `orders` хранит информацию о заказе, но не сами товары.
     - `order_items` хранит товары для заказов.
     - `stocks` хранит текущее состояние склада.
     - `reserves` хранит зарезервированные товары. При резервации товары отнимаются из `stocks` и переходят в `reserves`.
   - Миграции сейчас накатываю после `docker-compose up`, см. `Makefile:7 (run-all)`.
   - Изначально я думал хранить состав заказа и состав корзины в одной таблице, с помощью массива объектов типа
   `item`, объявленного прямо в PostgreSQL. Это позволило бы не делать пару транзакции, и избегать блокировок,
   но в итоге я решил что такой подход сильно усложняет логику. Тем не менее я успел написать кастомные `BinaryEncode`
   и `BinaryDecode` для структуры `Item`, чтобы pgx мог читать её. Всё это находится в отдельной ветке, если
   такой подход все же окажется предпочтительным, то можно будет довольно быстро переделать схемы.
2. Балансировщики
   - **pgBouncer** в Docker заработал достаточно быстро, я использовал образ `edoburu/pgbouncer`. pgBouncer для каждого
   сервиса объявлен в `docker-compose.yml`, но закомменчен, так как я в основном использую odyssey.
   - **Odyssey** в docker-compose работает на основе моего образа, `richardhere/odyssey`.
     - Dockerfile и docker-compose, предоставленные в репозитории проекта [Odyssey](https://github.com/yandex/odyssey/blob/76ea5f7169b26a70a4bf20cb990ea30ab8691d52/docker/Dockerfile)
     в основном предназначены для локального тестирования самого Odyssey (и при этом отказывались корректно работать у меня),
     так что я сделал чуть более лёгкий образ. В папке `./odyssey` лежит `Dockerfile`, использованный для сборки образа
     и `CMakeLists.txt`, который пришлось изменить. Остальные сурсы такие же, как в оригинальной репе, поэтому я не стал
     включать их в проект.
     - Конфигурации Odyssey и PostgreSQL находятся в папках `config` внутри сервисов.
3. Бизнес-логика
   - Учитывая, что некоторые детали бизнес-логики, судя по всему, остаются на усмотрение студентов, я пытался
   документировать поведение сервисов. Комментарии в слое бизнес-логики должны более-менее объяснить, что именно там происходит)
   
   
